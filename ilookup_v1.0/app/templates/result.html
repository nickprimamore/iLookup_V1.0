
<!-- This script is the one that takes the entry clicked on and relays the information into the modal -->
<script>
  $(document).ready(function() {
    $('.releaseReview').select2();
    $("[data-toggle=popover]").popover();
  })

  function loadAccordion(screen, cluster_name, release_number) {
    $.ajax({
      url:"/getTasks",
      type: "POST",
      data: JSON.stringify({
        clusterName: cluster_name,
        releaseNum: release_number
      }),
      success: function(response) {
        for (task of response) {
          let image = task.image_tag.substring(task.image_tag.length-7, task.image_tag.length)
          let memory = task.memory
          let date = task.date
          let cpu = task.cpu
          let revision = task.revision
          let task_name = task.task_definition_name

          let header = document.getElementById('accordionHeader' + screen.toString())
          header.innerHTML = release_number
          $( "#accordion" + screen.toString() ).append('<div class="card deleteOnClose' + screen.toString() + '">' +
            '<div class="card-header" id="headingOne">' +
              '<h5 class="mb-0 deleteOnClose">' +
                '<button class="btn btn-link deleteOnClose" data-toggle="collapse" data-target="#' + image + screen.toString() + '" aria-expanded="true" aria-controls="' + image + screen.toString() + '">' +
                task_name + '<br class="deleteOnClose"/>' +
                '</button>' +
              '</h5>' +
            '</div>'+
            '<div id="' + image + screen.toString() + '" class="collapse deleteOnClose" aria-labelledby="headingOne" data-parent="#accordion">' +
              '<table class="table table-bordered">' +
                '<tbody>' +
                  '<tr>' +
                    '<th scope="row">' + "Image Tag" + '</th>' +
                    '<td>' + image  + '</td>' +
                  '</tr>' +
                  '<tr>' +
                    '<th scope="row">' + "Revision" + '</th>' +
                    '<td>' + revision  + '</td>' +
                  '</tr>' +
                  '<tr>' +
                    '<th scope="row">' + "Date Started" + '</th>' +
                    '<td>' + date  + '</td>' +
                  '</tr>' +
                  '<tr>' +
                    '<th scope="row">' + "Memory" + '</th>' +
                    '<td>' + memory  + '</td>' +
                  '</tr>' +
                  '<tr>' +
                    '<th scope="row">' + "CPU" + '</th>' +
                    '<td>' + cpu  + '</td>' +
                  '</tr>' +
                '</tbody>' +
              '</table>' +
            '</div>' +
          '</div>')
        }
      }
    })
  }
  clusterName = ""
  product = ""
  region = ""
  $('#clusterDetail').on('show.bs.modal', function (event) {
    let trigger = $(event.relatedTarget)
    let releases = trigger.data('releases')
    let release = trigger.data('release')
    clusterName = trigger.data('clustername')
    product = trigger.data('product')
    region = trigger.data('region')
    $.ajax({
      url:"/getReleaseHistory",
      type: "POST",
      data: JSON.stringify({
        clusterName: clusterName
      }),
      success: function(response) {
        blankOption = new Option("", "", true, false)
        $('#release2').append(blankOption)
        for (let rel in response) {
          let newOption
          let secondOption
          let thirdOption
          if (release == response[rel]) {
            newOption = new Option(response[rel], response[rel], true, true);
            loadAccordion(1, clusterName, release)
            secondOption = new Option(response[rel], response[rel], true, false)
            thirdOption = new Option(response[rel], response[rel], true, false)
          } else {
            newOption = new Option(response[rel], response[rel], true, false);
            secondOption = new Option(response[rel], response[rel], true, false)
            thirdOption = new Option(response[rel], response[rel], true, false)
          }
          $('#release1').append(newOption)
          $('#release2').append(secondOption)
          $('#changeRelease').append(thirdOption)
        }

      }
    })
    let modal = $(this)
    modal.find('.cluster-title').text('Cluster: ' + clusterName)
  })


  function getClients(num) {
    let cliInfo = document.querySelector("#clientInfo" + num);
    console.log(cliInfo.dataset.cluster)
    console.log(cliInfo.dataset.release)
    $("#icon" + num).on("show.bs.popover", function () {
      $.ajax({
        url:"/getClients",
        type:"POST",
        data: JSON.stringify({
          clusterName: cliInfo.dataset.cluster,
          release: cliInfo.dataset.release
        }),
        success: function(response) {
          console.log(response)
          let info = document.querySelector('#icon' + num)
          info.setAttribute("data-content", response.toString())
        }
      })
    })
  }

  function updateRelease() {
    if (!$('#changeRelease').val()) {
      alert("No Release Selected for Change")
      return;
    }
    if (!document.getElementById('newRelease').value) {
      alert("Inputted New Release Value of (null).")
      return
    }
    if (document.getElementById('newRelease').value.length > 11) {
      alert("Check the format of the new Release value")
      return;
    }
    $.ajax({
      url:"/updateReleaseTable",
      type:"POST",
      data: JSON.stringify({
        clusterName: clusterName,
        product: product,
        newRelease: document.getElementById('newRelease').value,
        oldRelease: $('#changeRelease').val(),
        region: region
      }),
      success: function(response) {
        console.log(response)
      }
    })
  }

  $('#release1').on('select2:select', function(e) {
    $('.deleteOnClose1').remove()
    loadAccordion(1, clusterName, $('#release1').val())
  })

  $('#release2').on('select2:select', function(e) {
    $('.deleteOnClose2').remove()
    loadAccordion(2, clusterName, $('#release2').val())
  })

  $('#clusterDetail').on('hide.bs.modal', function (event){
    let header = document.getElementById('accordionHeader2')
    header.innerHTML = "Release Number"
    $('.deleteOnClose1').remove();
    $('.deleteOnClose2').remove();
    $('#release1 option').each(function() {
      $("#release1 option[value=" + "'" + $(this).val()  + "'" + "]").remove()
      $("#release1").select2('close')
    })
    $('#release2 option').each(function() {
      $("#release2 option[value=" + "'" + $(this).val()  + "'" + "]").remove()
      $("#release2").select2('close')
    })
    $('#changeRelease option').each(function() {
      $("#changeRelease option[value=" + "'" + $(this).val()  + "'" + "]").remove()
      $("#changeRelease").select2('close')
    })
  })

</script>

<style>
  div.modal-header {
    font-family: "Lato Light";
    font-weight: bold;
    padding: 10px;
    padding-bottom: 3px
  }
  .modal-backdrop {
    width: 100vw;
    height: 100vh;
    z-index: 0;
  }
  .modalWrapper {
    display: flex;
  }
  .comparisons {
    display: flex;
  }
  .insideModal {
    display: flex;
    flex-direction: column
  }
}


</style>
<!-- This is the modal and it is working with the function above to create multiple unique modal's based on which entry was pressed. -->
<div class="modal fade bd-example-modal-lg" id="clusterDetail" tabindex="-1" role="dialog" aria-labelledby="clusterLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h4 class="cluster-title" id="clusterLabel"></h4>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="insideModal">
        <div id="release_form" style="width:100%; display: block; border:1px solid #00508F">
          <label class="modalLabel" for="changeRelease">Change Release Number:</label>
          <br>
          <select class="releaseReview" id="changeRelease" style="width:45%" >
          </select>
          <input type="text" style="width:36%" id="newRelease" aria-describedby="newRelease" placeholder="Enter new Release">
          <button type="button" class="btn btn-primary" style="background-color:#007ACC" onclick="updateRelease()">Update Release</button>
        </div>
        <div class="comparisons">
          <div id="Screen1" style="width:50%">
            <div class="modalWrapper">
              <h5 style="width:50%"><div id="accordionHeader1">Release Number</div></h5>
              <div style="width:50%">
              <select class="releaseReview" id="release1" name="releases[]" style="width: 100%">

              </select>
              </div>
            </div>
            <div id="accordion1">


            </div>
          </div>
          <div id="divider" style="width: 0.5%; background-color: #00508F">

          </div>
          <div id="Screen2" style="width:50%">
            <div class="modalWrapper">
              <h5 style="width:50%"><div id="accordionHeader2"> Release Number </div></h5>
              <div style="width:50%">
                <select class="releaseReview" id="release2" name="releases[]" style="width: 100%">

                </select>
              </div>
            </div>
            <div id="accordion2">


            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<table class="table table-hover table-bordered table-striped">
  <thead>
    <tr>

      <th scope="col" style="font-family:Lato Light; font-size:16px">Product</th>
      <th scope="col" style="font-family:Lato Light; font-size:16px">Release #</th>
      <th scope="col" style="font-family:Lato Light; font-size:16px">Cluster</th>
      <th scope="col" style="font-family:Lato Light; font-size:16px">Region</th>
      <th scope="col" style="font-family:Lato Light; font-size:16px">Environment</th>
      <th scope="col" style="font-family:Lato Light; font-size:16px">Clients</th>
      <th scope="col" style="font-family:Lato Light; font-size:16px">Date Inserted</th>
      <th scope="col" style="font-family:Lato Light; font-size:16px">Active</th>
    </tr>
  </thead>
  <tbody>

<!-- This is a for loop to render the search results  -->
    {% for result in results %}
      {% set clients = result.client_names %}
      {% set timeRelease = result.release %}
      {% if timeRelease|length > 11 %}
        {% set timeRelease = "Update Release" %}
      {% endif %}
      <tr>
        <th scope="row" style="font-family:Lato Light; font-size:16px; padding-top:10px" data-toggle="modal"
        data-target="#clusterDetail"
        data-clustername="{{result.cluster_name}}"
        data-releases="{{result.releases}}"
        data-release="{{result.release}}"
        data-product="{{result.product_name}}"
        data-region="{{result.region}}">{{result.product_name}}</th>
        <td style="font-family:Lato Light; font-size:16px; padding-top:10px" data-toggle="modal"
        data-target="#clusterDetail"
        data-clustername="{{result.cluster_name}}"
        data-releases="{{result.releases}}"
        data-release="{{result.release}}"
        data-product="{{result.product_name}}"
        data-region="{{result.region}}"> {{timeRelease}} </td>
        <td style="font-family:Lato Light; font-size:16px; padding-top:10px" data-toggle="modal"
        data-target="#clusterDetail"
        data-clustername="{{result.cluster_name}}"
        data-releases="{{result.releases}}"
        data-release="{{result.release}}"
        data-product="{{result.product_name}}"
        data-region="{{result.region}}"> {{result.cluster_name}} </td>
        <td style="font-family:Lato Light; font-size:16px; padding-top:10px" data-toggle="modal"
        data-target="#clusterDetail"
        data-clustername="{{result.cluster_name}}"
        data-releases="{{result.releases}}"
        data-release="{{result.release}}"
        data-product="{{result.product_name}}"
        data-region="{{result.region}}"> {{result.region}} </td>
        <td style="font-family:Lato Light; font-size:16px; padding-top:10px" data-toggle="modal"
        data-target="#clusterDetail"
        data-clustername="{{result.cluster_name}}"
        data-releases="{{result.releases}}"
        data-release="{{result.release}}"
        data-product="{{result.product_name}}"
        data-region="{{result.region}}"> {{result.environment}} </td>
        <td style="font-family:Lato Light; font-size:16px; padding-top:10px"> <i class="fas fa-user-friends" data-toggle="popover" title="Clients Under This Cluster" data-content="{{clients|join(', ')}}"></i> </td>
        <td style="font-family:Lato Light; font-size:16px; padding-top:10px"> {{result.inserted_at[0:11]}} | {{result.inserted_at[11:16]}} </td>
        <td style="font-family:Lato Light; font-size:16px; padding-top:10px"> </td>
      </tr>
    {% endfor %}

  </tbody>
</table>

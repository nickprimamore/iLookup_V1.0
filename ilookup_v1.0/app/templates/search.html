{% extends "layout.html"%}

{% block content %}
<html>
<body style="background-color:#F8F8F8">
<!-- All the styles go in this style tag for any components within this page. Only use instyling if it is a one time use -->
<style>
  h1 {
    font-family:"Lato Light";
  }
  div.searchContainer {
    display:flex;
    flex-wrap:wrap;
    z-index:5;
    overflow:auto;
    height: 100%;
  }
  div.searchBar {
    text-align:left;
  }
  p.searchLabel {
    color:white;
    margin-bottom:5px;
    font-family: "Lato Light";
  }
  select.dropdowns {
    width: 100%
  }
  .modalLabel {
    color:#00508F;
    font-size: 18;
    font-weight:bold;
    font-family: "Lato Light"
  }
  /* .modal-header{
     border-bottom: 1px solid white;
  } */
</style>
<!-- This is the first script which deals with the front end AJAX call to implement dynamic searching with /search and /update -->
<script>
  //Select2 is an add-on package that allows you to have pill boxes with multiple inputs.
  //This /search is called the moment you load the page, creating the various options
  $(document).ready(function() {
    $.ajax({
      url: '/search',
      type: 'GET',
      success: function (response) {
        //These following forloops go through the passed in arrays of each possible search query, and creates an Option tag to add to the individual select2s
        for (let client in response.clientsQ) {
          let newOption = new Option(response.clientsQ[client], response.clientsQ[client], false, false);
          $('#clients').append(newOption);
        }
        for (let product in response.productsQ) {
          let newOption = new Option(response.productsQ[product], response.productsQ[product], false, false);
          $('#products').append(newOption);
        }
        for (let product in response.productsQ) {
          let newOption = new Option(response.productsQ[product], response.productsQ[product], false, false);
          $('#selectProduct').append(newOption);
        }
        for (let release in response.releasesQ) {
          let newOption = new Option(response.releasesQ[release], response.releasesQ[release], false, false);
          $('#releases').append(newOption);
        }
        for (let cluster in response.clustersQ) {
          let newOption = new Option(response.clustersQ[cluster], response.clustersQ[cluster], false, false);
          $('#clusters').append(newOption);
        }
        for (let cluster in response.clustersQ) {
          let newOption = new Option(response.clustersQ[cluster], response.clustersQ[cluster], false, false);
          $('#addClustersSelect2').append(newOption);
        }
        for (let region in response.regionsQ) {
          let newOption = new Option(response.regionsQ[region], response.regionsQ[region], false, false);
          $('#regions').append(newOption);
        }
        for (let region in response.regionsQ) {
          let newOption = new Option(response.regionsQ[region], response.regionsQ[region], false, false);
          $('#selectRegion').append(newOption);
        }
        for (let environment in response.environmentsQ) {
          let newOption = new Option(response.environmentsQ[environment], response.environmentsQ[environment], false, false);
          $('#environments').append(newOption);
        }
        for (let component in response.componentsQ) {
          let newOption = new Option(response.componentsQ[component], response.componentsQ[component], false, false);
          $('#components').append(newOption);
        }
      }
    })

    //Pre-loads result table with initial information
    $.ajax({
      url:'/result',
      type: 'GET',
      success: function(response) {
        $('#result-tag').html(response)
      }
    })

    //initializing the select2, .dropdowns is the classname for the main search page
    $('.dropdowns').select2({
      theme: "classic"
    });

    //Closes dropdowns after you unselect to allow for better UI experience
    $('.dropdowns').on('select2:unselect', function(e) {
      $('.dropdowns').select2('close')
    })

    //When something is selected or unselected, this function takes care of the dynamic aspect of it, as it get's the values chosen, sends it back as AJAX data
    //Once the backend generates the potential search queries, in the response, we delete the current options and reissue the new options
    $('.dropdowns').on('change.select2', function(e) {
      let values = getValues()
      $.ajax({
        url: '/update',
        type: 'POST',
        data: JSON.stringify({
          Clients: values[0],
          Products: values[1],
          Releases: values[2],
          Regions: values[3],
          Clusters: values[4],
          Environments: values[5],
          Components: values[6],
          Dates: values[7]
        }),
        success: function (response) {
          //These forloops delete all the options for each dropdown
          $('#clients option').each(function() {
            $("#clients option[value=" + $(this).val() +"]").remove()
            $('.clients').select2('close')
          })
          $('#products option').each(function() {
            $("#products option[value=" + $(this).val() +"]").remove()
            $('.products').select2('close')
          })
          $('#releases option').each(function() {
            $("#releases option[value=" + "'" + $(this).val() + "'" +"]").remove()
            $('.releases').select2('close')
          })
          $('#regions option').each(function() {
            $("#regions option[value=" + "'" + $(this).val() + "'" +"]").remove()
            $('.regions').select2('close')
          })
          $('#clusters option').each(function() {
            $("#clusters option[value=" + $(this).val() +"]").remove()
            $('.clusters').select2('close')
          })
          $('#environments option').each(function() {
            $("#environments option[value=" + $(this).val() +"]").remove()
            $('.components').select2('close')
          })
          //This for loop recreates the Options based on the selected values, allowing for a dynamic search filter
          for (let client in response.clientsUp) {
            let newOption
            if (values[0].includes(response.clientsUp[client])) {
              newOption = new Option(response.clientsUp[client], response.clientsUp[client], true, true);
            } else {
              newOption = new Option(response.clientsUp[client], response.clientsUp[client], true, false);
            }
            $('#clients').append(newOption);
          }
          for (let product in response.productsUp) {
            let newOption
            if (values[1].includes(response.productsUp[product])) {
              newOption = new Option(response.productsUp[product], response.productsUp[product], true, true);
            } else {
              newOption = new Option(response.productsUp[product], response.productsUp[product], true, false);
            }
            $('#products').append(newOption);
          }
          for (let releases in response.releasesUp) {
            let newOption
            if (values[2].includes(response.releasesUp[releases])) {
              newOption = new Option(response.releasesUp[releases], response.releasesUp[releases], true, true);
            } else {
              newOption = new Option(response.releasesUp[releases], response.releasesUp[releases], true, false);
            }
            $('#releases').append(newOption);
          }
          for (let cluster in response.clustersUp) {
            let newOption
            if (values[4].includes(response.clustersUp[cluster])) {
              newOption = new Option(response.clustersUp[cluster], response.clustersUp[cluster], true, true);
            } else {
              newOption = new Option(response.clustersUp[cluster], response.clustersUp[cluster], true, false);
            }
            $('#clusters').append(newOption);
          }
          for (let env in response.environmentsUp) {
            let newOption
            if (values[5].includes(response.environmentsUp[env])) {
              newOption = new Option(response.environmentsUp[env], response.environmentsUp[env], true, true);
            } else {
              newOption = new Option(response.environmentsUp[env], response.environmentsUp[env], true, false);
            }
            $('#environments').append(newOption);
          }
          for (let region in response.regionsUp) {
            let newOption
            if (values[3].includes(response.regionsUp[region])) {
              newOption = new Option(response.regionsUp[region], response.regionsUp[region], true, true);
            } else {
              newOption = new Option(response.regionsUp[region], response.regionsUp[region], true, false);
            }
            $('#regions').append(newOption);
          }
        }
      })
    })
  });

//This function is used in multiple calls, and it just grabs all selected values throughout the search page.
  function getValues() {
    //The format of $('._____').val() gives the results from the select2 Tables
    var clientVal = $('.clients').val()
    var productVal = $('.products').val()
    var releaseVal = $('.releases').val()
    var regionVal = $('.regions').val()
    var clusterVal = $('.clusters').val()
    var environmentVal = $('.environments').val()

    var dateFrom = document.getElementById("dateFrom").value;
    var dateUntil = document.getElementById("dateUntil").value;

    //Generated empty arrays, and filled them with the values from above to send to the backend as an array.
    var clientList = []
    var productList = []
    var releaseList = []
    var regionList = []
    var clusterList = []
    var environmentList = []
    var componentList = []
    var dateList = [dateFrom, dateUntil];

    //Populates all the lists with the search values
    for (var cli in clientVal) {
      clientList.push(clientVal[cli])
    }
    for (var pro in productVal) {
      productList.push(productVal[pro])
    }
    for (var rel in releaseVal) {
      releaseList.push(releaseVal[rel])
    }
    for (var reg in regionVal) {
      regionList.push(regionVal[reg])
    }
    for (var clu in clusterVal) {
      clusterList.push(clusterVal[clu])
    }
    for (var env in environmentVal) {
      environmentList.push(environmentVal[env])
    }

    return [clientList, productList, releaseList, regionList, clusterList, environmentList, componentList, dateList]
  }
  // This function sends the selected search tags to the backend and renders it onto the result-tag html
  function sendData() {
    let values = getValues()
    //send back and Ajax Request with the following information.
      $.ajax({
      url: '/result',
      type: 'POST',
      data: JSON.stringify({
        Clients: values[0],
        Products: values[1],
        Releases: values[2],
        Regions: values[3],
        Clusters: values[4],
        Environments: values[5],
        Components: values[6],
        Dates: values[7]
      }),
      success: function (response) {
        $('#result-tag').html(response)
      }
    })
  }

  //This function clears all Search Bars and the trigger('change') makes for a reupdate on options
  function clearSearchBars() {
    $('.dropdowns').val(null).trigger('change');
    $('.date').val('')
  }

</script>

<style>
  #body-row {
      margin-left:0;
      margin-right:0;
      width:100%;
  }
  #sidebar-container {
      min-height: 90vh;
      background-color: #00508F;
      padding: 0;
      padding-top:14px;
      padding-left:0px;
      padding-right:2px;
      overflow:auto;
      height: 93vh;
  }

  /* Sidebar sizes when expanded and expanded */
  .sidebar-expanded {
      width: 300px;
  }

  .sidebar-collapsed {
      width: 60px;
  }

  /* Menu item*/
  #sidebar-container .list-group a {
      height: 50px;
      color: white;
  }

  /* Submenu item*/
  #sidebar-container .list-group .sidebar-submenu a {
      height: 45px;
      padding-left: 30px;
  }

  /* Separators */
  .sidebar-separator-title {
      background-color: #333;
      height: 35px;
  }
  .sidebar-separator {
      background-color: #333;
      height: 25px;
  }

  /* Closed submenu icon */
  #sidebar-container .list-group .list-group-item[aria-expanded="false"] .submenu-icon::after {
    content: " \f0d7";
    font-family: FontAwesome;
    text-align: right;
    padding-left: 5px;
  }
  /* Opened submenu icon */
  #sidebar-container .list-group .list-group-item[aria-expanded="true"] .submenu-icon::after {
    content: " \f0da";
    font-family: FontAwesome;
    text-align: right;
    padding-left: 5px;
  }

  #result-tag {
    height: 91vh;
    overflow: auto;
  }

  .col {
    padding-left: 0px;
    padding-right: 0px;
  }

  .modal-backdrop {
    width: 100vw;
    height: 100vh;
    z-index: 0;
  }

</style>

<!-- This is the html for the actual search bars -->
<!-- Bootstrap row -->
<div class="row" id="body-row">
    <!-- Sidebar -->
    <div id="sidebar-container" class="sidebar-expanded d-none d-md-block"><!-- d-* hides the Sidebar in smaller devices. Its itens can be kept on the Navbar 'Menu' -->
            <!-- /END Separator -->
            <div class="searchContainer">
              <div class="searchBar col-md-12">
                <p class="searchLabel clientSelect" style="text-align:center; font-size:18"> <b> Search AWS Resources </b> </p>
              </div>
              <div class="searchBar col-md-12">
                <p class="searchLabel clientSelect"> <b> Clients: </b> </p>
                <select class="dropdowns clients" id="clients" name="clients[]" multiple="multiple">

                </select>
              </div>
              <div class="searchBar col-md-12">
                <p class="searchLabel productSelect"> <b> Products: </b> </p>
                <select class="dropdowns products" id="products" name="products[]" multiple="multiple">

                </select>
              </div>
              <div class="searchBar col-md-12">
                <p class="searchLabel releaseSelect"> <b> Releases: </b> </p>
                <select class="dropdowns releases" id="releases" name="releases[]" multiple="multiple">

                </select>
              </div>
              <div class="searchBar col-md-12">
                <p class="searchLabel regionSelect"> <b> Regions: </b> </p>
                <select class="dropdowns regions" id="regions" name="regions[]" multiple="multiple">

                </select>
              </div>
              <div class="searchBar col-md-12">
                <p class="searchLabel clusterSelect"> <b> Clusters: </b> </p>
                <select class="dropdowns clusters" id="clusters" name="clusters[]" multiple="multiple">

                </select>
              </div>
              <div class="searchBar col-md-12">
                <p class="searchLabel environmentSelect"> <b> Environments: </b> </p>
                <select class="dropdowns environments" id="environments"  name="environments[]" multiple="multiple">

                </select>
              </div>
              <div class="form-group col-md-12">
                  <p class="searchLabel"> <b> Date (From): </b> </p>
                  <input type="date" class="form-control date" id="dateFrom"name="Date (From)">
              </div>
              <div class="form-group col-md-12" style="margin-top:-18">
                  <p class="searchLabel"> <b> Date (To): </b> </p>
                  <input type="date" class="form-control date" id="dateUntil" name="Date (Until)">
              </div>

              <div class="searchBar col-md-6">
                <button type="button" class="btn btn-light" style="width:100%; margin-bottom: 15px; font-weight:bold; color:#00508F" onClick="sendData()">Search</button>
              </div>

              <div class ="clearButton col-md-6">
                <button type="button" class="btn btn-light" style="width:100%; margin-bottom: 15px; font-weight:bold; color:#00508F" onClick="clearSearchBars()">Clear All</button>
              </div>
            </div>
    </div><!-- sidebar-container END -->

    <!-- MAIN -->
    <div class="col" >
      <!-- This is where the results are being rendered -->
      <div id="result-tag">      </div>

    </div><!-- Main Col END -->

</div><!-- body-row END -->

<!-- This script tag is to deal with the creation and receiving information of cluster tags -->
<script>

let addReleaseTag = {}

  //We seperately initialize these select2's because we want them to work independently from the rest of the search page as they require their own unique way of dynamicFiltering
  $(document).ready(function() {
    $('.productsTag').select2({
      theme: "classic"
    });

    $('.regionsTag').select2({
      theme: "classic"
    });

    $('.clustersTag').select2({
      theme: "classic"
    });

    $('.editTag').select2({
      theme: "classic",
      tags: true
    });


    function getTagValues() {
      var productTag = $('#selectProduct').val()
      var regionTag = $('#selectRegion').val()
      var clusterTag = $('#addClustersSelect2').val()
      var clusterList = []
      var productList = []
      var regionList = []
      for (var pro in productTag) {
        productList.push(productTag[pro])
      }
      for (var reg in regionTag) {
        regionList.push(regionTag[reg])
      }
      for (var cli in clusterTag) {
        clusterList.push(clusterTag[cli])
      }
      return [productList, regionList, clusterList]
    }

    //The following event handlers keep track of the several clusters chosen
    $('.clustersTag').on('change.select2', function(e) {
      let selectedCluster = $('.clustersTag').val()
      $.ajax({
       url:'/getTags',
       type:'POST',
       data: JSON.stringify({
         clusterList: selectedCluster
       }),
       success: function(response) {
         $('.tagTable').remove()

         //sets up the table with AWS tags to be appended in the modal
         let tableStr = '<table class="table table-striped tagTable"><thead><tr>'
         if (Object.keys(response).length != 0) {
            tableStr += '<th scope="col">Cluster</th>'
         }

         for (resp in response) {
           tableStr += '<th scope="col">' + resp + '</th>'
         }

         tableStr += '</tr></thead><tbody>'
         for (i = 0; i < selectedCluster.length; i++) {
           tableStr += '<tr><th scope="row">' + selectedCluster[i] + '</th>'
           for (res in response) {
             tableStr += '<td>' + response[res][i] + '</td>'
           }
           tableStr += '</tr>'
         }
         tableStr += '</tbody></table>'
         $('.tags').append(tableStr)

         $('#editTag option').each(function() {
           $("#editTag option[value=" + $(this).val() +"]").remove()
         })
         for (resp in response) {
           let newOption = new Option(resp, resp, true, false)
           $('.editTag').append(newOption)
         }
       }
     })
    })

    $('.updateTags').on('change.select2', function(e) {
      addReleaseTag['product'] = $('.productsTag').val()[0]
      addReleaseTag['region'] = $('.regionsTag').val()[0]
      console.log(addReleaseTag)
      values = getTagValues()
      console.log('The Values Are', values)
      $.ajax({
        url:'/update',
        type: 'POST',
        data: JSON.stringify({
          Clients: [],
          Products: values[0],
          Releases: [],
          Regions: values[1],
          Clusters: [],
          Environments: [],
          Dates: []
        }),
        success: function (response) {
          $('#selectProduct option').each(function() {
            $("#selectProduct option[value=" +  $(this).val()  + "]").remove()
            $("#selectProduct").select2('close')
          })
          $('#selectRegion option').each(function() {
            $("#selectRegion option[value=" + "'" + $(this).val() + "'" + "]").remove()
            $("#selectRegion").select2('close')
          })
          $('#addClustersSelect2 option').each(function() {
            $("#addClustersSelect2 option[value=" + $(this).val() + "]").remove()
            $("#addClustersSelect2").select2('close')
          })
          console.log("does this move?")
          for (let product in response.productsUp) {
            let newOption
            if (values[0].includes(response.productsUp[product])) {
              newOption = new Option(response.productsUp[product], response.productsUp[product], true, true);
            } else {
              newOption = new Option(response.productsUp[product], response.productsUp[product], true, false);
            }
            $('#selectProduct').append(newOption);
          }
          for (let region in response.regionsUp) {
            console.log(region)
            let newOption
            if (values[1].includes(response.regionsUp[region])) {
              newOption = new Option(response.regionsUp[region], response.regionsUp[region], true, true);
            } else {
              newOption = new Option(response.regionsUp[region], response.regionsUp[region], true, false);
            }
            $('#selectRegion').append(newOption);
          }
          for (let cluster in response.clustersUp) {
            let newOption
            console.log(cluster)
            if (values[2].includes(response.clustersUp[cluster])) {
              newOption = new Option(response.clustersUp[cluster], response.clustersUp[cluster], true, true);
            } else {
              newOption = new Option(response.clustersUp[cluster], response.clustersUp[cluster], true, false);
            }
            $('#addClustersSelect2').append(newOption);
          }
        }
      })
    })
  });

  //This function creates an object for the newTag and sends it to the backend for it to be created on AWS servers
  function newTag() {
    addReleaseTag['clusters'] = $('.clustersTag').val()
    let tagValue = document.getElementById('tagValue').value
    addReleaseTag['tagValue'] = tagValue
    addReleaseTag['tagKey'] = $('.editTag').val()
    console.log(addReleaseTag)
    $.ajax({
      url:'/newTag',
      type:'POST',
      data: JSON.stringify({
        tagQuery: addReleaseTag
      }),
      success: function(response) {
        console.log("Created")
        alert("Successfully added/updated tag")
      }
    })
  }

  function deleteTag() {
    if (!$('.editTag').val()) {
      alert("Select a tag in order to delete")
      return;
    }
    if ($('.editTag').val() == 'Product' || $('.editTag').val() == 'Release') {
      alert("Cannot delete that tag")
      return;
    }
    addReleaseTag['clusters'] = $('.clustersTag').val()
    addReleaseTag['tagKey'] = $('.editTag').val()
    if (confirm("Are you sure you want to delete " + addReleaseTag['tagKey'] + " from the following Cluster(s)?: " + addReleaseTag["clusters"])) {
      $.ajax({
        url:"/deleteTag",
        type:'POST',
        data:JSON.stringify({
          tagQuery: addReleaseTag
        }),
        success: function(response) {
          console.log("Tag Deleted")
          alert("Tag deleted")
        }
      })
    }
  }
</script>
  <!-- modal for adding/updating an AWS cluster tag -->
  <div class="modal fade no-reload" id="addTagModal" tabindex="-1" role="dialog" aria-labelledby="addTagLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="addTagLabel" style="font-family:Lato Light; font-weight:bold">Add/Update an AWS Cluster Tag</h5>
          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        <div class="modal-body">
          <form>
              <div class="form-group">
                <label class="modalLabel" for="selectProduct">Product:</label>
                <br>
                <select class="productsTag updateTags" id="selectProduct" style="width:100%" name="selectProduct" multiple="multiple">

                </select>
              </div>
          </form>
          <form>
              <div class="form-group">
                <label class="modalLabel" for="selectRegion">Region:</label>
                <br>
                <select class="regionsTag updateTags" id="selectRegion" style="width:100%" name="selectRegion" multiple="multiple">

                </select>
              </div>
          </form>
          <form>
            <div class="searchBar col-md-6" style="padding-left:0px; padding-right:24.8px">
              <p class="modalLabel"> <b> Cluster(s):</b> </p>
                <select class="clustersTag" id="addClustersSelect2" style="width:214%" name="addClustersSelect2" multiple="multiple">
                </select>
            </div>
          </form>
          <div class="tags">
            <table class="table table-striped tagTable">

            </table>
          </div>
          <form>
            <div class="col-md-3" style="padding-left:0px; padding-right:25.5px; display: inline-block">
              <label class="modalLabel" for="selectTag">Tag:</label>
              <br>
              <select class="editTag" id="editTag" placeholder="Select tag" style="width:100%" name="editTag">

              </select>
            </div>
            <div class="col-md-8" style="padding-left:0px; padding-right:0px; display: inline-block">
              <input type="text" class="form-control" id="tagValue" aria-describedby="tagFormat" placeholder="Enter new value here">
              <!-- <small id="tagFormat" class="form-text text-muted">Example release format: 1.1.1.1</small> -->
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-danger mr-auto" style="font-family: Lato Light; font-weight:bold;" onclick="deleteTag()">Delete tag</button>
          <button type="button" class="btn btn-primary" style="background-color:#007ACC; font-family: Lato Light; font-weight:bold" data-dismiss="modal" onclick="newTag()">Save/add tag</button>
        </div>
      </div>
    </div>
  </div>

<!-- This clears the tagging modal once you close it-->
<script>
  $('#addTagModal').on('hidden.bs.modal', function (e) {
    $('#addClustersSelect2').val(null).trigger('change');
    $('#selectRegion').val(null).trigger('change');
    $('#selectProduct').val(null).trigger('change')
    $('#tagValue').val(null).trigger('change')
  });
</script>

</body>
</html>

{% endblock %}

{% extends "layout.html"%}

{% block content %}
<html>
<body style="background-color:#F8F8F8">
<!-- All the styles go in this style tag for any components within this page. Only use instyling if it is a one time use -->
<style>
  h1 {
    font-family:"Lato Light";
  }
  div.searchContainer {
    display:flex;
    flex-wrap:wrap;
    z-index:5;
    overflow:auto;
    height: 100%;
  }
  div.searchBar {
    text-align:left;
  }
  p.searchLabel {
    color:white;
    font-size:16px;
    margin-bottom:3px;
    font-family: "Lato Light";
  }
  select.dropdowns {
    width: 100%
  }
  .modalLabel {
    color:#00508F;
    font-size: 18;
    font-weight:bold;
    font-family: "Lato Light"
  }
  #body-row {
      margin-left:0;
      margin-right:0;
      width:100%;
  }
  #sidebar-container {
      min-height: 90vh;
      background-color: #00508F;
      padding: 0;
      padding-top:5px;
      padding-left:0px;
      padding-right:2px;
      overflow:auto;
      height: 93vh;
  }

  /* Sidebar sizes when expanded and expanded */
  .sidebar-expanded {
      width: 18vw;
  }

  .sidebar-collapsed {
      width: 60px;
  }

  /* Menu item*/
  #sidebar-container .list-group a {
      height: 50px;
      color: white;
  }

  /* Submenu item*/
  #sidebar-container .list-group .sidebar-submenu a {
      height: 45px;
      padding-left: 30px;
  }

  /* Separators */
  .sidebar-separator-title {
      background-color: #333;
      height: 35px;
  }
  .sidebar-separator {
      background-color: #333;
      height: 25px;
  }

  /* Closed submenu icon */
  #sidebar-container .list-group .list-group-item[aria-expanded="false"] .submenu-icon::after {
    content: " \f0d7";
    font-family: FontAwesome;
    text-align: right;
    padding-left: 5px;
  }
  /* Opened submenu icon */
  #sidebar-container .list-group .list-group-item[aria-expanded="true"] .submenu-icon::after {
    content: " \f0da";
    font-family: FontAwesome;
    text-align: right;
    padding-left: 5px;
  }

  #result-tag {
    height: 91vh;
    overflow: auto;
  }

  .col {
    padding-left: 0px;
    padding-right: 0px;
  }

  .modal-backdrop {
    width: 100vw;
    height: 100vh;
    z-index: 0;
  }

  .iLookup{
    margin: auto;
    font-size:19;
    font-family: "Lato Light";
    color: white;
  }

  .select2-search__field{
    width: 5em !important;
  }

  .table-wrapper{
    width: 100%;

    overflow:auto;
  }
</style>
<!-- This is the first script which deals with the front end AJAX call to implement dynamic searching with /search and /update -->
<script>
  //Select2 is an add-on package that allows you to have pill boxes with multiple inputs.
  //This /search is called the moment you load the page, creating the various options
  $(document).ready(function() {
    //initializing the select2 for side search bar, .dropdowns is the classname for the main search page
    $('.dropdowns').select2({
      theme: 'classic',
      width: "100%"
    });

    $("#active").prop("checked", true);

    //Pre-loads result table with initial information
    $.ajax({
      url:'/result',
      type: 'GET',
      success: function(response) {
        $('#result-tag').html(response)
      }
    })

    //This function populates the search bars with valid search filters
    $.ajax({
      url: '/update',
      type: 'POST',
      data: JSON.stringify({
        Clients: [],
        Products: [],
        Releases: [],
        Regions: [],
        Clusters: [],
        Environments: [],
        Components: [],
        Dates: [],
        Active: true
      }),
      success: function (response) {
        //This if else is for determining whether the release or cluster search bar should be disabled or not
        $("#releases").prop("disabled", true);
        $("#clusters").prop("disabled", true);

        //This for loop recreates the Options based on the selected values, allowing for a dynamic search filter
        let newOption
        for (let client in response.clientsUp) {
          newOption = new Option(response.clientsUp[client], response.clientsUp[client], true, false);
          $('#clients').append(newOption);
        }
        for (let product in response.productsUp) {
          newOption = new Option(response.productsUp[product], response.productsUp[product], true, false);
          $('#products').append(newOption);
        }
        for (let releases in response.releasesUp) {
          newOption = new Option(response.releasesUp[releases], response.releasesUp[releases], true, false);
          $('#releases').append(newOption);
        }
        for (let cluster in response.clustersUp) {
          newOption = new Option(response.clustersUp[cluster], response.clustersUp[cluster], true, false);
          $('#clusters').append(newOption);
        }
        for (let env in response.environmentsUp) {
          newOption = new Option(response.environmentsUp[env], response.environmentsUp[env], true, false);
          $('#environments').append(newOption);
        }
        for (let region in response.regionsUp) {
          newOption = new Option(response.regionsUp[region], response.regionsUp[region], true, false);
          $('#regions').append(newOption);
        }
      }
    })

    //Closes dropdowns after you unselect to avoid selection errors
    $('.dropdowns').on('select2:unselect', function(e) {
      $('.dropdowns').select2('close')
    })

    //When something is selected or unselected, this function takes care of the dynamic aspect of it, as it get's the values chosen, sends it back as AJAX data
    //Once the backend generates the potential search queries, in the response, we delete the current options and reissue the new options
    //changedOnce is used to administer the disabled functionality so you have to choose a Product in order to select Release and Clusters
    changedOnce = false
    $('.dropdowns').on('change.select2', function(e) {
      let values = getValues()
      $.ajax({
        url: '/update',
        type: 'POST',
        data: JSON.stringify({
          Clients: values[0],
          Products: values[1],
          Releases: values[2],
          Regions: values[3],
          Clusters: values[4],
          Environments: values[5],
          Components: values[6],
          Dates: values[7],
          Active: values[8]
        }),
        success: function (response) {
          //This if else is for determining whether the release or cluster search bar should be disabled or not
          if(values[1].length > 0){
            $("#releases").prop("disabled", false);
            $("#clusters").prop("disabled", false);
            changedOnce = false
          }
          else{
            $("#releases").prop("disabled", true);
            $("#clusters").prop("disabled", true);
            //This solves a bug of disabling on the chance that multiple were selected, this checks to make sure that the value trigger only occurs the first time it becomes enabled
            if(changedOnce == false){
              $('#releases').val(null).trigger('change')
              $('#clusters').val(null).trigger('change')
              changedOnce = true
            }
          }
          //these for loops are to delete all the current options in the client dropdowns
          $('#clients option').each(function() {
            $("#clients option[value=" +"'"+ $(this).val() +"'"+"]").remove()
            $('.clients').select2('close')
          })
          $('#products option').each(function() {
            $("#products option[value=" + $(this).val() +"]").remove()
            $('.products').select2('close')
          })
          $('#releases option').each(function() {
            $("#releases option[value=" + "'" + $(this).val() + "'" +"]").remove()
            $('.releases').select2('close')
          })
          $('#regions option').each(function() {
            $("#regions option[value=" + "'" + $(this).val() + "'" +"]").remove()
            $('.regions').select2('close')
          })
          $('#clusters option').each(function() {
            $("#clusters option[value=" + $(this).val() +"]").remove()
            $('.clusters').select2('close')
          })
          $('#environments option').each(function() {
            $("#environments option[value=" + $(this).val() +"]").remove()
            $('.components').select2('close')
          })
          //This for loop recreates the Options based on the selected values, allowing for a dynamic search filter
          let newOption
          for (let client in response.clientsUp) {
            if (values[0].includes(response.clientsUp[client])) {
              newOption = new Option(response.clientsUp[client], response.clientsUp[client], true, true);
            } else {
              newOption = new Option(response.clientsUp[client], response.clientsUp[client], true, false);
            }
            $('#clients').append(newOption);
          }
          for (let product in response.productsUp) {
            if (values[1].includes(response.productsUp[product])) {
              newOption = new Option(response.productsUp[product], response.productsUp[product], true, true);
            } else {
              newOption = new Option(response.productsUp[product], response.productsUp[product], true, false);
            }
            $('#products').append(newOption);
          }
          for (let releases in response.releasesUp) {
            if (values[2].includes(response.releasesUp[releases])) {
              newOption = new Option(response.releasesUp[releases], response.releasesUp[releases], true, true);
            } else {
              newOption = new Option(response.releasesUp[releases], response.releasesUp[releases], true, false);
            }
            $('#releases').append(newOption);
          }
          for (let cluster in response.clustersUp) {
            if (values[4].includes(response.clustersUp[cluster])) {
              newOption = new Option(response.clustersUp[cluster], response.clustersUp[cluster], true, true);
            } else {
              newOption = new Option(response.clustersUp[cluster], response.clustersUp[cluster], true, false);
            }
            $('#clusters').append(newOption);
          }
          for (let env in response.environmentsUp) {
            if (values[5].includes(response.environmentsUp[env])) {
              newOption = new Option(response.environmentsUp[env], response.environmentsUp[env], true, true);
            } else {
              newOption = new Option(response.environmentsUp[env], response.environmentsUp[env], true, false);
            }
            $('#environments').append(newOption);
          }
          for (let region in response.regionsUp) {
            if (values[3].includes(response.regionsUp[region])) {
              newOption = new Option(response.regionsUp[region], response.regionsUp[region], true, true);
            } else {
              newOption = new Option(response.regionsUp[region], response.regionsUp[region], true, false);
            }
            $('#regions').append(newOption);
          }
        }
      })
    })
  });

  //This function is used in multiple calls, and it just grabs all selected values throughout the search page, when searching
  function getValues() {
    //The format of $('._____').val() gives the results from the select2 Tables, for active and inactive we just check what's ticked
    var clientVal = $('.clients').val()
    var productVal = $('.products').val()
    var releaseVal = $('.releases').val()
    var regionVal = $('.regions').val()
    var clusterVal = $('.clusters').val()
    var environmentVal = $('.environments').val()
    var activeVal = $('#active').prop("checked") == true
    var inactiveVal = $('#inactive').val()
    var dateFrom = document.getElementById("dateFrom").value;
    var dateUntil = document.getElementById("dateUntil").value;

    //Generated empty arrays, and filled them with the values from above to send to the backend as an array.
    var clientList = []
    var productList = []
    var releaseList = []
    var regionList = []
    var clusterList = []
    var environmentList = []
    var componentList = []
    var actOrIn = ""
    var dateList = [dateFrom, dateUntil];

    //Populates all the lists with the search values
    for (var cli in clientVal) {
      clientList.push(clientVal[cli])
    }
    for (var pro in productVal) {
      productList.push(productVal[pro])
    }
    for (var rel in releaseVal) {
      releaseList.push(releaseVal[rel])
    }
    for (var reg in regionVal) {
      regionList.push(regionVal[reg])
    }
    for (var clu in clusterVal) {
      clusterList.push(clusterVal[clu])
    }
    for (var env in environmentVal) {
      environmentList.push(environmentVal[env])
    }

    //This is to determine the potential search query of having all, just the active, or just inactive
    //None means both or neither
    //True means active was selected
    //False means inactive was selected
    if ($('#active').prop("checked") == true && ($('#inactive').prop("checked") == true)) {
      actOrIn = "None"
    } else if ($('#active').prop("checked") == true) {
      actOrIn = true
    } else if ($('#inactive').prop("checked") == true) {
      actOrIn = false
    } else {
      actOrIn = "None"
    }
    return [clientList, productList, releaseList, regionList, clusterList, environmentList, componentList, dateList, actOrIn]
  }

  // This function sends the selected search tags to the backend and renders it onto the result-tag html
  function sendData() {
    let values = getValues()
    //send back and Ajax Request with the following information.
      $('#loadedCheck').show()
      $('.table').hide()
      $.ajax({
      url: '/result',
      type: 'POST',
      data: JSON.stringify({
        Clients: values[0],
        Products: values[1],
        Releases: values[2],
        Regions: values[3],
        Clusters: values[4],
        Environments: values[5],
        Components: values[6],
        Dates: values[7],
        Active: values[8]
      }),
      success: function (response) {
        $('#result-tag').html(response)
      }
    })
  }

  //This function clears all Search Bars and the trigger('change') makes for a reupdate on options as well as nullify all the other search queries
  function clearSearchBars() {
    $('.dropdowns').val(null).trigger('change');
    $('.date').val('')
    $("#active").prop("checked", false);
    $("#inactive").prop("checked", false);
    sendData();
  }

  //This function is for the pure need of having to cause a manual trigger when active / inactive is selected
  function triggerUpdate() {
    $('.dropdowns').trigger('change.select2')
  }

</script>
<!-- This is the html for the side searchbar menu-->
<!-- Bootstrap row -->
<div class="row" id="body-row">
    <!-- Sidebar -->
    <div id="sidebar-container" class="sidebar-expanded d-none d-md-block"><!-- d-* hides the Sidebar in smaller devices. Its itens can be kept on the Navbar 'Menu' -->
            <!-- /END Separator -->
            <div class="searchContainer">
              <div class="searchBar col-md-12">
                <p class="searchLabel productSelect"> <b> Products: </b> </p>
                <select class="dropdowns products" id="products" name="products[]" multiple="multiple">

                </select>
              </div>
              <div class="searchBar col-md-12">
                <p class="searchLabel releaseSelect"> <b> Releases: </b> </p>
                <select class="dropdowns releases" id="releases" name="releases[]" multiple="multiple">

                </select>
              </div>
              <div class="searchBar col-md-12">
                <p class="searchLabel clusterSelect"> <b> Clusters: </b> </p>
                <select class="dropdowns clusters" id="clusters" name="clusters[]" multiple="multiple">

                </select>
              </div>
              <div class="searchBar col-md-12">
                <p class="searchLabel regionSelect"> <b> Regions: </b> </p>
                <select class="dropdowns regions" id="regions" name="regions[]" multiple="multiple">

                </select>
              </div>
              <div class="searchBar col-md-12">
                <p class="searchLabel environmentSelect"> <b> Environments: </b> </p>
                <select class="dropdowns environments" id="environments"  name="environments[]" multiple="multiple">

                </select>
              </div>
              <div class="searchBar col-md-12">
                <p class="searchLabel clientSelect"> <b> Clients: </b> </p>
                <select class="dropdowns clients" id="clients" name="clients[]" multiple="multiple">

                </select>
              </div>
              <div class="searchBar col-md-12">
                <p class="searchLabel activeSelect"> <b> Active Clusters: </b> </p>
                <!-- These two divs are the check boxes with onclick handlers -->
                <div class="form-check form-check-inline">
                  <input class="form-check-input" type="checkbox" id="active" onclick="triggerUpdate()" value="true">
                  <label class="form-check-label" style="color: white" for="active">Active</label>
                </div>
                <div class="form-check form-check-inline" style="margin-left: 3.4vw">
                  <input class="form-check-input" type="checkbox" id="inactive" onclick="triggerUpdate()" value="false">
                  <label class="form-check-label" style="color: white" for="inactive">Inactive</label>
                </div>
              </div>
              <div class="form-group col-md-12">
                  <p class="searchLabel"> <b> Date (From): </b> </p>
                  <input type="date" class="form-control date" id="dateFrom"name="Date (From)">
              </div>
              <div class="form-group col-md-12" style="margin-top:-18">
                  <p class="searchLabel"> <b> Date (To): </b> </p>
                  <input type="date" class="form-control date" id="dateUntil" name="Date (Until)">
              </div>
              <div class="searchBar col-md-6">
                <button type="button" class="btn btn-light" style="width:100%; margin-bottom: 15px; font-weight:bold; color:#00508F" onClick="sendData()">Search</button>
              </div>

              <div class ="clearButton col-md-6">
                <button type="button" class="btn btn-light" style="width:100%; margin-bottom: 15px; font-weight:bold; color:#00508F" onClick="clearSearchBars()">Clear All</button>
              </div>
            </div>
    </div><!-- sidebar-container END -->

    <!-- MAIN -->
    <div class="col" >
      <!-- This is where the results are being rendered -->
      <div id="result-tag">      </div>

    </div><!-- Main Col END -->

</div><!-- body-row END -->


<!-- Everything below this line deals with the tag modal, we split everything, but the styling up so it becomes easier to navigate -->

<script>
  //This object is to record the tag query
  let addReleaseTag = {}
  changeMade = false
  //We seperately initialize these select2's because we want them to work independently from the rest of the search page as they require their own unique way of dynamicFiltering
  $(document).ready(function() {
    //initially disable region and clusters in the tagging modal
    $("#selectRegion").prop("disabled", true);
    $("#addClustersSelect2").prop("disabled", true);
    $('.dependencies').select2({
      theme: "classic"
    });
    $('.editTag').select2({
      theme: "classic",
      tags: true
    });

    //This function gets the values of what is needed to create a new Tag on AWS and returns a list of the results to pass back to the backend
    function getTagValues() {
      var productTag = $('#selectProduct').val()
      var regionTag = $('#selectRegion').val()
      var clusterTag = $('#addClustersSelect2').val()
      var clusterList = []
      var productList = []
      var regionList = []
      for (var pro in productTag) {
        productList.push(productTag[pro])
      }
      for (var reg in regionTag) {
        regionList.push(regionTag[reg])
      }
      for (var cli in clusterTag) {
        clusterList.push(clusterTag[cli])
      }
      return [productList, regionList, clusterList]
    }

    //The following event handlers keep track of the several clusters chosen, and renders the table to show the several tags onto a cluster
    $('.clustersTag').on('change.select2', function(e) {
      let selectedCluster = $('.clustersTag').val()
      $.ajax({
       url:'/getTags',
       type:'POST',
       data: JSON.stringify({
         clusterList: selectedCluster,
         region: addReleaseTag['region']
       }),
       success: function(response) {
         $('.tagTable').remove()
         //This part sets up the table with AWS tags to be appended in the modal, the styling up above allows this to be scrollable so don't have to worry about having too many tags.
         let tableStr = '<div class="table-wrapper"><table class="table table-striped tagTable"><thead><tr>'
         if (Object.keys(response).length != 0) {
            tableStr += '<th scope="col">Cluster</th>'
         }
         for (resp in response) {
           tableStr += '<th scope="col">' + resp + '</th>'
         }
         tableStr += '</tr></thead><tbody>'
         for (i = 0; i < selectedCluster.length; i++) {
           tableStr += '<tr><th scope="row">' + selectedCluster[i] + '</th>'
           for (res in response) {
             tableStr += '<td>' + response[res][i] + '</td>'
           }
           tableStr += '</tr>'
         }
         tableStr += '</tbody></table></div>'
         $('.tags').append(tableStr)
         $('#editTag option').each(function() {
           $("#editTag option[value=" + $(this).val() +"]").remove()
         })
         for (resp in response) {
           //This part is redoing the select bar for the tags, and used to keep the previously selected option already selected to begin with.
           let newOption
           if (addReleaseTag['tagKey'] == resp) {
             newOption = new Option(resp, resp, true, true)
           }
           else {
             newOption = new Option(resp, resp, true, false)
           }
           $('.editTag').append(newOption)
         }
       }
     })
    })

    //This function checks to see if products is selected, in order to determine whether selectRegion and addClustersSelect2
    $('.updateTags').on('change.select2', function(e) {
      //if product selected, enable region
      if($('.productsTag').val()[0]){
        $("#selectRegion").prop("disabled", false);
      }
      //if region selected, enable cluster
      if($('.regionsTag').val()[0]){
        $("#addClustersSelect2").prop("disabled", false);
      }
      //if a product is deselected, disable region and cluster
      if(!$('.productsTag').val()[0]){
        $("#selectRegion").prop("disabled", true);
        $('#selectRegion').val(null);
        $("#addClustersSelect2").prop("disabled", true);
      }
      //if region is deselected, disable cluster
      if(!$('.regionsTag').val()[0]){
        $("#addClustersSelect2").prop("disabled", true);
        $('#addClustersSelect2').val(null);
      }

      //the addReleaseTag is getting populated with values after it has been clicked
      addReleaseTag['product'] = $('.productsTag').val()[0]
      addReleaseTag['region'] = $('.regionsTag').val()[0]
      values = getTagValues()
      //After getting the tag values, we send it into the update function to have a dynamic filter
      $.ajax({
        url:'/update',
        type: 'POST',
        data: JSON.stringify({
          Clients: [],
          Products: values[0],
          Releases: [],
          Regions: values[1],
          Clusters: [],
          Environments: [],
          Dates: []
        }),
        success: function (response) {
          console.log("hoooo")
          $('#selectProduct option').each(function() {
            $("#selectProduct option[value=" +  $(this).val()  + "]").remove()
            $("#selectProduct").select2('close')
          })
          $('#selectRegion option').each(function() {
            $("#selectRegion option[value=" + "'" + $(this).val() + "'" + "]").remove()
            $("#selectRegion").select2('close')
          })
          $('#addClustersSelect2 option').each(function() {
            $("#addClustersSelect2 option[value=" + $(this).val() + "]").remove()
            $("#addClustersSelect2").select2('close')
          })
          let newOption
          for (let product in response.productsUp) {
            if (values[0].includes(response.productsUp[product])) {
              newOption = new Option(response.productsUp[product], response.productsUp[product], true, true);
            } else {
              newOption = new Option(response.productsUp[product], response.productsUp[product], true, false);
            }
            $('#selectProduct').append(newOption);
          }
          for (let region in response.regionsUp) {
            if (values[1].includes(response.regionsUp[region])) {
              newOption = new Option(response.regionsUp[region], response.regionsUp[region], true, true);
            } else {
              newOption = new Option(response.regionsUp[region], response.regionsUp[region], true, false);
            }
            $('#selectRegion').append(newOption);
          }
          for (let cluster in response.clustersUp) {
            if (values[2].includes(response.clustersUp[cluster])) {
              newOption = new Option(response.clustersUp[cluster], response.clustersUp[cluster], true, true);
            } else {
              newOption = new Option(response.clustersUp[cluster], response.clustersUp[cluster], true, false);
            }
            $('#addClustersSelect2').append(newOption);
          }
        }
      })
    })
  });

  //This function creates an object for the newTag and sends it to the backend for it to be created on AWS servers
  function newTag() {
    //These ensure form validation
    if ($('.editTag').val() == 'Release'){
      let newRel = document.getElementById('tagValue').value;

      //Creates a set to eventually check if the release number only has numbers and no letters
      const numberSet = new Set(['0','1','2','3','4','5','6','7','8','9']);

      //Counts the amount of dots in the release number (should be 3)
      let dotCount = 0;
      let index;
      for(index = 0; index < newRel.length; index++){
        if(newRel.charAt(index) === '.'){
          dotCount++;
        }
        else if(numberSet.has(newRel.charAt(index)) == false){
          $('#noLettersAlert').show('fade');
          window.setTimeout(function() {
            $("#noLettersAlert").hide('fade');
          }, 3500);
          return;
        }
      }
      //Checking for incorrect format of the release number entered
      if(newRel.length > 11 || newRel.length < 7 || dotCount != 3){
        $('#releaseFormatAlert').show('fade');
        window.setTimeout(function() {
          $("#releaseFormatAlert").hide('fade');
        }, 3500);
        return;
      }
    }
    //The following are checking for various different alerts, based on selected values, invalid formats, etc
    if(!$('.productsTag').val()[0]){
      $('#selectProductAlert').show('fade');
      window.setTimeout(function() {
        $("#selectProductAlert").hide('fade');
      }, 3000);
      return;
    }
    if(!$('.regionsTag').val()[0]){
        $('#selectRegionAlert').show('fade');
        window.setTimeout(function() {
          $("#selectRegionAlert").hide('fade');
        }, 3000);
        return;
    }
    if(!$('.clustersTag').val().length > 0){
        $('#selectClusterAlert').show('fade');
        window.setTimeout(function() {
          $("#selectClusterAlert").hide('fade');
        }, 3000);
        return;
    }
    if(!$('#tagValue').val()){
      $('#newValueAlert').show('fade');
      window.setTimeout(function() {
        $("#newValueAlert").hide('fade');
      }, 3000);
      return;
    }
    if (!isValid(addReleaseTag['tagValue'])) {
      $('#specialKeyAlert').show('fade');
      window.setTimeout(function() {
        $('#specialKeyAlert').hide('fade');
      }, 3000)
      return;
    }
    //this part further adds onto the addRelease Tag based on the things you chose after it passes the different things
    addReleaseTag['clusters'] = $('.clustersTag').val()
    addReleaseTag['tagValue'] = document.getElementById('tagValue').value
    addReleaseTag['tagKey'] = $('.editTag').val()

    //this is dealing with the AWS side, to make sure that the characters used in the tagging methodology is actually correct.
    function isValid(str){
      return !/[~`!#$%\^&*+=\-\[\]\\';,/{}|\\":<>\?]/g.test(str);
    }
    //This function calls the backend to create a new tag onto a certain cluster which is found through addReleaseTag
    $.ajax({
      url:'/newTag',
      type:'POST',
      data: JSON.stringify({
        tagQuery: addReleaseTag
      }),
      success: function(response) {
        //This further checks for alerts from the back end, or it triggers clustersTag which will recreate the table in order to have a level of dynamic changes
        if (response == "Client already exists") {
          $('#duplicateTagAlert').show('fade');
          window.setTimeout(function() {
            $("#duplicateTagAlert").hide('fade');
          }, 3000);
        }
        else {
          $('.clustersTag').trigger({
            type: 'change.select2',
          })
          $('#successTagAlert').show('fade');
          window.setTimeout(function() {
            $("#successTagAlert").hide('fade');
          }, 3000);
          changeMade = true
        }
        //This just clears out the tagValue bar, for better UI experience
        $('#tagValue').val(null).trigger('change')
      }
    })
  }

  //This function deletes a tag
  function deleteTag() {
    //This will check to make sure that everything is correctly chosen
    if (!$('.editTag').val()) {
      $('#selectBeforeDeleteAlert').show('fade');
      window.setTimeout(function() {
        $("#selectBeforeDeleteAlert").hide('fade');
      }, 3000);
      return;
    }
    if ($('.editTag').val() == 'Product' || $('.editTag').val() == 'Release' || $('.editTag').val() == 'Environment') {
      $('#cannotDeleteAlert').show('fade');
      window.setTimeout(function() {
        $("#cannotDeleteAlert").hide('fade');
      }, 3000);
      return;
    }
    //When deleting this rechecks to make sure there is a Key and cluster chosen otherwise it'll toss an error.
    addReleaseTag['clusters'] = $('.clustersTag').val()
    addReleaseTag['tagKey'] = $('.editTag').val()
    //This confirm just pops up to double check it wasn't a misclick
    if (confirm("Are you sure you want to delete " + addReleaseTag['tagKey'] + " from the following Cluster(s)?: " + addReleaseTag["clusters"])) {
      $.ajax({
        url:"/deleteTag",
        type:'POST',
        data:JSON.stringify({
          tagQuery: addReleaseTag
        }),
        success: function(response) {
          //This causes the table to update dynamically to see changes made to AWS
          changeMade = true
          $('.clustersTag').trigger({
            type: 'change.select2',
          })
          $('#deleteAlert').show('fade');
          window.setTimeout(function() {
            $("#deleteAlert").hide('fade');
          }, 3000);
        }
      })
    }
  }


</script>
  <!-- modal for adding/updating an AWS cluster tag -->
  <div class="modal fade no-reload" id="addTagModal" tabindex="-1" role="dialog" aria-labelledby="addTagLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h4 class="modal-title" id="addTagLabel" style="font-family:Lato Light; font-weight:bold">Add/Update an AWS Cluster Tag</h4>
          <br><br>
          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        <div class="modal-body">
          <form>
              <div class="form-group">
                <label class="modalLabel" for="selectProduct">Product:</label>
                <br>
                <select class="productsTag updateTags dependencies" id="selectProduct" style="width:100%" name="selectProduct" multiple="multiple">
                </select>
              </div>
          </form>
          <form>
              <div class="form-group">
                <label class="modalLabel" for="selectRegion">Region:</label>
                <br>
                <select class="regionsTag updateTags dependencies" id="selectRegion" style="width:100%" name="selectRegion" multiple="multiple">
                </select>
              </div>
          </form>
          <form>
            <div class="searchBar col-md-6" style="padding-left:0px; padding-right:24.8px">
              <p class="modalLabel"> <b> Cluster(s):</b> </p>
                <select class="clustersTag dependencies" id="addClustersSelect2" style="width:214%" name="addClustersSelect2" multiple="multiple">
                </select>
                <small id="multipleClusters" class="form-text text-muted" style="">*Note: Multiple clusters can be selected</small>
            </div>
          </form>
          <div class="tags">
            <table class="table table-striped tagTable">
            </table>
          </div>
          <form>
            <div class="col-md-3" style="padding-left:0px; padding-right:25.5px; display: inline-block">
              <label class="modalLabel" for="selectTag">Tag:</label>
              <br>
              <select class="editTag" id="editTag" placeholder="Select tag" style="width:100%" name="editTag">
              </select>
            </div>
            <div class="col-md-8" style="padding-left:0px; padding-right:0px; display: inline-block">
              <input type="text" class="form-control" style="width:112%" id="tagValue" aria-describedby="tagFormat" placeholder="Enter new value here">
            </div>
            <small id="tagFormat" class="form-text text-muted" style="margin-left:195.6px">Example release format: 1.1.1.1</small>
            <br>
            <div id="successTagAlert" class="alert alert-primary collapse">
              <a id="closeSuccessAlert" href="#" class="close">&times;</a>
              <strong>Successfully added/updated tag!</strong>
            </div>
            <div id="selectBeforeDeleteAlert" class="alert alert-danger collapse">
              <a id="closeSelectBeforeDeleteAlert" href="#" class="close">&times;</a>
              <strong>Select a tag in order to delete it.</strong>
            </div>
            <div id="duplicateTagAlert" class="alert alert-danger collapse">
              <a id="closeDuplicateTagAlert" href="#" class="close">&times;</a>
              <strong>This client already exists as a tag</strong>
            </div>
            <div id="cannotDeleteAlert" class="alert alert-danger collapse">
              <a id="closeCannotDeleteAlert" href="#" class="close">&times;</a>
              <strong>Deletion of this tag is restricted.</strong>
            </div>
            <div id="deleteAlert" class="alert alert-danger collapse">
              <a id="closeDeleteAlert" href="#" class="close">&times;</a>
              <strong>Tag deleted.</strong>
            </div>
            <div id="selectProductAlert" class="alert alert-danger collapse">
              <a id="closeSelectProductAlert" href="#" class="close">&times;</a>
              <strong>Please select a product.</strong>
            </div>
            <div id="selectRegionAlert" class="alert alert-danger collapse">
              <a id="closeSelectRegionAlert" href="#" class="close">&times;</a>
              <strong>Please select a region.</strong>
            </div>
            <div id="selectClusterAlert" class="alert alert-danger collapse">
              <a id="closeSelectClusterAlert" href="#" class="close">&times;</a>
              <strong>Please select a cluster.</strong>
            </div>
            <div id="newValueAlert" class="alert alert-danger collapse">
              <a id="closeNewValueAlert" href="#" class="close">&times;</a>
              <strong>Please enter a new tag value.</strong>
            </div>
            <div id="releaseFormatAlert" class="alert alert-danger collapse">
              <a id="closeReleaseFormatAlert" href="#" class="close">&times;</a>
              <strong>Please check the release number format.</strong>
            </div>
            <div id="noLettersAlert" class="alert alert-danger collapse">
              <a id="closeNoLettersAlert" href="#" class="close">&times;</a>
              <strong>Release number cannot contain any letters/symbols.</strong>
            <div id="specialKeyAlert" class="alert alert-danger collapse">
              <a id="closeSpecialKeyAlert" href="#" class="close">&times;</a>
              <strong>Invalid Keys for AWS Tags</strong>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button id="deleteButton" type="button" class="btn btn-danger mr-auto" style="font-family: Lato Light; font-weight:bold;" onclick="deleteTag()">Delete tag</button>
          <button id="saveButton" type="button" class="btn btn-primary" style="background-color:#007ACC; font-family: Lato Light; font-weight:bold" onclick="newTag()">Save/add tag</button>
        </div>
      </div>
    </div>
  </div>

  <script type="text/javascript">
    //This script tag takes care of the various alert functionalities and clearing the modal once you x out of it
    $(document).ready(function () {
      $('#closeSuccessAlert').click(function () {
        $('#successTagAlert').hide('fade');
      });
      $('#closeSelectBeforeDeleteAlert').click(function () {
        $('#selectBeforeDeleteAlert').hide('fade');
      });
      $('#closeCannotDeleteAlert').click(function () {
        $('#cannotDeleteAlert').hide('fade');
      });
      $('#closeDeleteAlert').click(function () {
        $('#deleteAlert').hide('fade');
      });
      $('#closeSelectProductAlert').click(function () {
        $('#selectProductAlert').hide('fade');
      });
      $('#closeSelectRegionAlert').click(function () {
        $('#selectRegionAlert').hide('fade');
      });
      $('#closeSelectClusterAlert').click(function () {
        $('#selectClusterAlert').hide('fade');
      });
      $('#closeNewValueAlert').click(function () {
        $('#newValueAlert').hide('fade');
      });
      $('#closeReleaseFormatAlert').click(function () {
        $('#releaseFormatAlert').hide('fade');
      });
      $('#closeDuplicateTagAlert').click(function () {
        $('#duplicateTagAlert').hide('fade');
      });
      $('#closeNoLettersAlert').click(function () {
        $('#noLettersAlert').hide('fade');
      });
      $('#closeSpecialKeyAlert').click(function () {
        $('#specialKeyAlert').hide('fade');
      })
    });
    //This method is used to clear all the values so results don't overlap if you close and open another modal.
    $('#addTagModal').on('hidden.bs.modal', function (e) {
      $('#addClustersSelect2').val(null).trigger('change');
      $('#selectRegion').val(null).trigger('change');
      $('#selectProduct').val(null).trigger('change')
      $('#tagValue').val(null).trigger('change')
      if (changeMade) {
        sendData()
        changeMade = false
      }
    });
  </script>
</body>
</html>

{% endblock %}

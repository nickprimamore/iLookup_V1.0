{% extends "layout.html"%}

{% block content %}
<html>
<body style="background-color:#F8F8F8">
<!-- All the styles go in this style tag for any components within this page. Only use instyling if it is a one time use -->
<style>
  h1 {
    font-family:"Trebuchet MS";
  }
  div.searchContainer {
    display:flex;
    flex-wrap:wrap;
    margin: 0% 20%;
    z-index:5;
    overflow:auto;
  }
  div.searchBar {
    text-align:left;
  }
  p.searchLabel {
    color:#2867b1;
    margin-bottom:5px;
    font-family: "Trebuchet MS";
  }
  select.dropdowns {
    width: 100%
  }
  label.modalLabel {
    color:#2867b1;
    font-weight:bold;
    font-family: "Trebuchet MS"
  }
</style>
<!-- This is the first script which deals with the front end AJAX call to implement dynamic searching with /search and /update -->
<script>
  //Select2 is an add-on package that allows you to have pill boxes with multiple inputs.
  //This /search is called the moment you load the page, creating the various options
  $(document).ready(function() {
    $.ajax({
      url: '/search',
      type: 'GET',
      success: function (response) {
        clientStr = ""
        productStr = ""
        releasesStr = ""
        clustersStr = ""
        clustersTagStr = ""
        environmentsStr = ""
        regionsStr = ""
        componentsStr = ""
        productsTagStr = ""
        clientObj = {
          "results": []
        }
        //These following forloops go through the passed in arrays of each possible search query, and creates an Option tag to add to the individual select2s
        for (let client in response.clientsQ) {
          let newOption = new Option(response.clientsQ[client], response.clientsQ[client], false, false);
          $('#clients').append(newOption);
        }
        for (let product in response.productsQ) {
          let newOption = new Option(response.productsQ[product], response.productsQ[product], false, false);
          $('#products').append(newOption);
        }
        for (let release in response.releasesQ) {
          let newOption = new Option(response.releasesQ[release], response.releasesQ[release], false, false);
          $('#releases').append(newOption);
        }
        for (let cluster in response.clustersQ) {
          let newOption = new Option(response.clustersQ[cluster], response.clustersQ[cluster], false, false);
          $('#clusters').append(newOption);
        }
        for (let region in response.regionsQ) {
          let newOption = new Option(response.regionsQ[region], response.regionsQ[region], false, false);
          $('#regions').append(newOption);
        }
        for (let environment in response.environmentsQ) {
          let newOption = new Option(response.environmentsQ[environment], response.environmentsQ[environment], false, false);
          $('#environments').append(newOption);
        }
        for (let component in response.componentsQ) {
          let newOption = new Option(response.componentsQ[component], response.componentsQ[component], false, false);
          $('#components').append(newOption);
        }
      }
    })

    //initializing the select2, .dropdowns is the classname for the main search page
    $('.dropdowns').select2({
      theme: "classic"
    });

    //Closes dropdowns after you unselect to allow for better UI experience
    $('.dropdowns').on('select2:unselect', function(e) {
      $('.dropdowns').select2('close')
    })

    //When something is selected or unselected, this function takes care of the dynamic aspect of it, as it get's the values chosen, sends it back as AJAX data
    //Once the backend generates the potential search queries, in the response, we delete the current options and reissue the new options
    $('.dropdowns').on('change.select2', function(e) {
      let values = getValues()
      $.ajax({
        url: '/update',
        type: 'POST',
        data: JSON.stringify({
          Clients: values[0],
          Products: values[1],
          Releases: values[2],
          Regions: values[3],
          Clusters: values[4],
          Environments: values[5],
          Components: values[6],
          Dates: values[7]
        }),
        success: function (response) {
          clientStr = ""
          productStr = ""
          releasesStr = ""
          clustersStr = ""
          environmentsStr = ""
          regionsStr = ""
          //These forloops delete all the options for each dropdown
          $('#clients option').each(function() {
            $("#clients option[value=" + $(this).val() +"]").remove()
            $('.clients').select2('close')
          })
          $('#products option').each(function() {
            $("#products option[value=" + $(this).val() +"]").remove()
            $('.products').select2('close')
          })
          $('#releases option').each(function() {
            $("#releases option[value=" + "'" + $(this).val() + "'" +"]").remove()
            $('.releases').select2('close')
          })
          $('#regions option').each(function() {
            $("#regions option[value=" + "'" + $(this).val() + "'" +"]").remove()
            $('.regions').select2('close')
          })
          $('#clusters option').each(function() {
            $("#clusters option[value=" + $(this).val() +"]").remove()
            $('.clusters').select2('close')
          })
          $('#environments option').each(function() {
            $("#environments option[value=" + $(this).val() +"]").remove()
            $('.components').select2('close')
          })
          //This for loop recreates the Options based on the selected values, allowing for a dynamic search filter
          for (let client in response.clientsUp) {
            let newOption
            if (values[0].includes(response.clientsUp[client])) {
              newOption = new Option(response.clientsUp[client], response.clientsUp[client], true, true);
            } else {
              newOption = new Option(response.clientsUp[client], response.clientsUp[client], true, false);
            }
            $('#clients').append(newOption);
          }
          for (let product in response.productsUp) {
            let newOption
            if (values[1].includes(response.productsUp[product])) {
              newOption = new Option(response.productsUp[product], response.productsUp[product], true, true);
            } else {
              newOption = new Option(response.productsUp[product], response.productsUp[product], true, false);
            }
            $('#products').append(newOption);
          }
          for (let releases in response.releasesUp) {
            let newOption
            if (values[2].includes(response.releasesUp[releases])) {
              newOption = new Option(response.releasesUp[releases], response.releasesUp[releases], true, true);
            } else {
              newOption = new Option(response.releasesUp[releases], response.releasesUp[releases], true, false);
            }
            $('#releases').append(newOption);
          }
          for (let cluster in response.clustersUp) {
            let newOption
            if (values[4].includes(response.clustersUp[cluster])) {
              newOption = new Option(response.clustersUp[cluster], response.clustersUp[cluster], true, true);
            } else {
              newOption = new Option(response.clustersUp[cluster], response.clustersUp[cluster], true, false);
            }
            $('#clusters').append(newOption);
          }
          for (let env in response.environmentsUp) {
            let newOption
            if (values[5].includes(response.environmentsUp[env])) {
              newOption = new Option(response.environmentsUp[env], response.environmentsUp[env], true, true);
            } else {
              newOption = new Option(response.environmentsUp[env], response.environmentsUp[env], true, false);
            }
            $('#environments').append(newOption);
          }
          for (let region in response.regionsUp) {
            let newOption
            if (values[3].includes(response.regionsUp[region])) {
              newOption = new Option(response.regionsUp[region], response.regionsUp[region], true, true);
            } else {
              newOption = new Option(response.regionsUp[region], response.regionsUp[region], true, false);
            }
            $('#regions').append(newOption);
          }
        }
      })
    })
  });

//This function is used in multiple calls, and it just grabs all selected values throughout the search page.
  function getValues() {
    //The format of $('._____').val() gives the results from the select2 Tables
    var clientVal = $('.clients').val()
    var productVal = $('.products').val()
    var releaseVal = $('.releases').val()
    var regionVal = $('.regions').val()
    var clusterVal = $('.clusters').val()
    var environmentVal = $('.environments').val()
    var componentVal = $('components').val()

    var dateFrom = document.getElementById("dateFrom").value;
    var dateUntil = document.getElementById("dateUntil").value;

    //Generated empty arrays, and filled them with the values from above to send to the backend as an array.
    var clientList = []
    var productList = []
    var releaseList = []
    var regionList = []
    var clusterList = []
    var environmentList = []
    var componentList = []
    var dateList = [dateFrom, dateUntil];

    //Populates all the lists with the search values
    for (var cli in clientVal) {
      clientList.push(clientVal[cli])
    }
    for (var pro in productVal) {
      productList.push(productVal[pro])
    }
    for (var rel in releaseVal) {
      releaseList.push(releaseVal[rel])
    }
    for (var reg in regionVal) {
      regionList.push(regionVal[reg])
    }
    for (var clu in clusterVal) {
      clusterList.push(clusterVal[clu])
    }
    for (var env in environmentVal) {
      environmentList.push(environmentVal[env])
    }
    for (var com in componentVal) {
      componentList.push(componentVal[com])
    }
    return [clientList, productList, releaseList, regionList, clusterList, environmentList, componentList, dateList]
  }
  // This function sends the selected search tags to the backend and renders it onto the result-tag html
  function sendData() {
    let values = getValues()
    //send back and Ajax Request with the following information.
      $.ajax({
      url: '/result',
      type: 'POST',
      data: JSON.stringify({
        Clients: values[0],
        Products: values[1],
        Releases: values[2],
        Regions: values[3],
        Clusters: values[4],
        Environments: values[5],
        Components: values[6],
        Dates: values[7]
      }),
      success: function (response) {
        $('#result-tag').html(response)
      }
    })
  }

  //This function clears all Search Bars and the trigger('change') makes for a reupdate on options
  function clearSearchBars() {
    $('.dropdowns').val(null).trigger('change');
  }

</script>

<!-- This is the html for the actual search bars -->
<h1 style="padding-top:70px; padding-bottom:11px; text-align: center"> Search <span style="color:#FF9900">aws</span> Resources</h1>

<div class="searchContainer">
  <div class="searchBar col-md-6">
    <p class="searchLabel clientSelect"> <b> Clients: </b> </p>
    <select class="dropdowns clients" id="clients" name="clients[]" multiple="multiple">

    </select>
  </div>
  <div class="searchBar col-md-6">
    <p class="searchLabel productSelect"> <b> Products: </b> </p>
    <select class="dropdowns products" id="products" name="products[]" multiple="multiple">

    </select>
  </div>
  <div class="searchBar col-md-6">
    <p class="searchLabel releaseSelect"> <b> Releases: </b> </p>
    <select class="dropdowns releases" id="releases" name="releases[]" multiple="multiple">

    </select>
  </div>
  <div class="searchBar col-md-6">
    <p class="searchLabel regionSelect"> <b> Regions: </b> </p>
    <select class="dropdowns regions" id="regions" name="regions[]" multiple="multiple">

    </select>
  </div>
  <div class="searchBar col-md-6">
    <p class="searchLabel clusterSelect"> <b> Clusters: </b> </p>
    <select class="dropdowns clusters" id="clusters" name="clusters[]" multiple="multiple">

    </select>
  </div>
  <div class="searchBar col-md-6">
    <p class="searchLabel environmentSelect"> <b> Environments: </b> </p>
    <select class="dropdowns environments" id="environments"  name="environments[]" multiple="multiple">

    </select>
  </div>
  <div class="searchBar col-md-6">
    <p class="searchLabel componentSelect"> <b> Components: </b> </p>
    <select class="dropdowns components" id="components"  name="components[]" multiple="multiple">

    </select>
  </div>
  <div class="form-group col-md-3" style = padding-right:1%>
      <!--<label for="date (from)">Date (From)</label>!-->
      <p class="searchLabel"> <b> Date (From): </b> </p>
      <input type="date" class="form-control" id="dateFrom"name="Date (From)">
  </div>
  <div class="form-group col-md-3">
      <!--<label for="date (until)">Date (Until)</label>-->
      <p class="searchLabel"> <b> Date (Until): </b> </p>
      <input type="date" class="form-control" id="dateUntil" name="Date (Until)">
  </div>

  <div class="searchBar col-md-6">
    <button type="button" class="btn btn-outline-primary" style="width:100%; font-weight:bold" onClick="sendData()">Search</button>
  </div>

  <div class ="clearButton col-md-6">
    <button type="button" class="btn btn-outline-primary" style="width:100%; font-weight:bold" onClick="clearSearchBars()">Clear All</button>
  </div>

  <br>
  <br>
  <br>

<!-- This script tag is to deal with the creation and receiving information of cluster tags -->
<script>

let addReleaseTag = {}
let selectedCluster = []

  //We seperately initialize these select2's because we want them to work independently from the rest of the search page as they require their own unique way of dynamicFiltering
  $(document).ready(function() {
    $('.productsTag').select2({
      theme: "classic"
    });

    $('.clustersTag').select2({
      theme: "classic"
    });

    //Since it's a single pill choice, we only need a select function so it finds the clusters for the products chosen.
    $('.productsTag').on('select2:select', function(e) {
      let data = e.params.data
      addReleaseTag['product'] = data.text
    })

    //The following 2 event handlers keep track of the several clusters chosen
    $('.clustersTag').on('select2:select', function(e) {
      let data = e.params.data
      selectedCluster.push(data.text)
    })

    $('.clustersTag').on('select2:unselect', function(e) {
      let data = e.params.data
      let unselected = data.text
      for (let i = 0; i < selectedCluster.length; i++) {
        if (selectedCluster[i] == unselected) {
          selectedCluster.splice(i, 1)
        }
      }
    })
  });

  //This function creates an object for the newTag and sends it to the backend for it to be created on AWS servers
  function newTag() {
    addReleaseTag['clusters'] = selectedCluster
    let releaseNum = document.getElementById('releaseNum').value
    addReleaseTag['releaseNum'] = releaseNum
    $.ajax({
      url:'/newTag',
      type:'POST',
      data: JSON.stringify({
        tagQuery: addReleaseTag
      }),
      success: function(response) {
        alert(response)
      }
    })
  }

  //This is just to initial the addTag Modal
  $('#addTagModal').on('hidden.bs.modal', function (e) {
      $(this)
        .find("input, select")
        .val('')
        .end()
        $('#addClustersSelect2').val(null).trigger('change');
  });

  </script>
  <!-- Modal for adding a release tag -->
  <div class="modal fade no-reload" id="addTagModal" tabindex="-1" role="dialog" aria-labelledby="addTagLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="addTagLabel">Add/Update a Release Tag:</h5>
          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        <div class="modal-body">
          <form>
              <div class="form-group">
                <label class="modalLabel" for="selectProduct">Product:</label>
                <br>
                <select class="productsTag" id="selectProduct" placeholder="Select product" style="width:100%">
                  <option value="" disabled selected>Select product</option>
                  {% for product in productsTag %}
                    <option value="{{ product.product_name }}">{{ product.product_name }}</option>
                  {% endfor %}
                </select>
              </div>
          </form>
          <form>
            <div class="form-group">
              <label class="modalLabel" for="releaseNum">Release Number:</label>
              <input type="email" class="form-control" id="releaseNum" aria-describedby="releaseFormat" placeholder="Enter release">
              <small id="releaseFormat" class="form-text text-muted">Example format: 1.1.1.1</small>
            </div>
          </form>
          <form>
            <div class="searchBar col-md-6">
              <p class="searchLabel"> <b> Cluster(s):</b> </p>
                <select class="clustersTag" id="addClustersSelect2" style="width:214%" name="addClustersSelect2" multiple="multiple">
                  {% for cluster in clustersTag %}
                  <option value="{{ cluster.cluster_name }}">{{ cluster.cluster_name }}</option>
                  {% endfor %}
                </select>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-primary" data-dismiss="modal" onclick="newTag()">Add tag</button>
        </div>
      </div>
    </div>
  </div>


<!-- This is where the table is being rendered in! -->
</div>
<div id="result-tag">      </div>
</body>
</html>

{% block resultContent%}
{% endblock %}

{% endblock %}
